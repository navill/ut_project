# 21018

### pytest - file 테스트

-   파일 업로드 테스트 코드 작성

-   테스트 코드에서 파일 객체를 생성하고 post에 첨부하여 endpoint에 전송

    ```python
    @pytest.mark.django_db
    def test_api_create_data_file(client_with_token_auth, prescription):
        upload_file = SimpleUploadedFile("file.txt", b"test file", content_type='multipart/form-data')
        value = {
            'prescription': prescription.id,
            'file': upload_file
        }
        url = reverse('files:file-upload')
        response = client_with_token_auth.post(url, data=value, format='multipart')
        assert response.status_code == 201
        assert 'txt/doctortest.com_file' in response.data['file']
    ```

### 문제점

-   pytest가 실행될 때 마다 파일이 storage에 저장됨
    -   주로 pytest-watch를 사용하기 때문에 test코드에 변경사항이 적용될 때 마다 파일이 스토리지에 누적되는 문제 발생

### 해결

-   fixture를 이용하여 테스트 동작에서 사용되고 사라질 파일 객체를 생성

    ```python
    # conftest.py
    @pytest.fixture
    def upload_file():
        upload_file = SimpleUploadedFile("file.txt", b"test file", content_type='multipart/form-data')
        return upload_file
    
    # view_tests.py
    @pytest.mark.django_db
    def test_api_create_data_file(client_with_token_auth, prescription, upload_file):
        value = {
            'prescription': prescription.id,
            'file': upload_file
        }
        url = reverse('files:file-upload')
        response = client_with_token_auth.post(url, data=value, format='multipart')
        assert response.status_code == 201
        assert 'txt/doctortest.com_file' in response.data['file']
    ```

    

