# 210123

### DRF - 다중 파일 업로드

-   Prescription 생성 시 File(DoctorFile)을 여러개 업로드

-   처음에는 DictField + nested serializer(DoctorFileInPrescriptionSerializer)를 이용해 파일을 업로드 시도

    ```python
    class PrescriptionCreateSerializer(serializers.ModelSerializer):
        url = serializers.HyperlinkedIdentityField(
            view_name='prescriptions:prescription-detail-update',
            lookup_field='pk'
        )
        writer = serializers.HiddenField(default=CurrentDoctorDefault())
        patient = FilteredPrimaryKeyRelatedField(queryset=Patient.objects.select_all(),
                                                 write_only=True, related_id='doctor_id')
        doctor_files = serializers.DictField(child=DoctorFileInPrescriptionSerializer(many=True))
    
    # Error
    ...
    File "/Users/jh/Desktop/ut_django/venv/lib/python3.7/site-packages/rest_framework/fields.py", line 1722, in to_representation
        for key, val in value.items()
    AttributeError: 'RelatedManager' object has no attribute 'items'
    ```

    -   'doctor_files'는 Prescription의 역참조 이름(DoctorFile(related_name='doctor_files'))
    -   데이터를 생성한 후 DictField.to_representation에서 값을 출력할 때 value값에 RelatedManager 객체가 전달되면서 'items'를 호출 할 수 없음
    -   DictField.to_representation을 오버라이딩하려다 DictField를 잘 못 사용하는게 아닌가 생각함
        -   복수의 관계형을 나타내기 위해 DictField를 사용하는게 맞지 않다고 생각(NestedSerializer(many=True)를  사용하는게 맞을거라 생각함)
        -   억지로 화면에 뿌리기 위해 to_representation을 오버라이딩 하는것은 오버엔지니어링인듯

<br>

-   [stackoverflow](https://stackoverflow.com/a/48762785) 에서 다중 파일 업로드 관련 답변을 참고하함

```python
class PrescriptionCreateSerializer(serializers.ModelSerializer):
    writer = serializers.HiddenField(default=CurrentDoctorDefault())
    patient = FilteredPrimaryKeyRelatedField(queryset=Patient.objects.select_all(),
                                             write_only=True, related_id='doctor_id')
    doctor_files = DoctorFileInPrescriptionSerializer(many=True, read_only=True)

    class Meta(DefaultPrescriptionSerializer.Meta):
        fields = DefaultPrescriptionSerializer.Meta.fields 

    @transaction.atomic
    def create(self, validated_data):
        writer = validated_data.pop('writer')
        request_files = self.context['request'].FILES
        files = self._validate_file_fieldname(request_files)

        prescription = Prescription.objects.create(writer=writer, **validated_data)
        for doctor_file in files:
            DoctorFile.objects.create(uploader_id=writer.user_id, prescription_id=prescription.id, file=doctor_file)
        return prescription

    def _validate_file_fieldname(self, file_keys: MultiValueDict):
        for key in file_keys.keys():
            if 'upload_file' not in key:
                raise ValueError
        return file_keys

```

-   파일 업로드와 화면 출력을 분리

    -   파일 업로드
        1.  Prescription 객체 생성
        2.  request.FILE을 이용해 파일 객체(DoctorFile)를 생성 + Prescription 연결

    -   출력: 기존의 DoctorFileInPrescriptionSerializer 사용 

-   request.FILE에 전달된 필드는 PrescriptionSerializer에 등록되지 않은 필드도 가능

    -   django의 request[POST]는 파일 객체(InMemmoryUpload)를 request.FILES에 담아 보냄

    -   따라서 serializer에 별도의 필드를 지정하지 않고 request.FILE을 이용해 여러개의 파일을 수신할 수 있다.

    -   파일의 필드 네임에 대해 무분별하게 사용되지 않도록 validator를 이용해 파일 필드 이름('upload_file')을 강제 한다.

        ex: upload_file1(O), upload_file_2(O), random_file(X)

